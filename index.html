<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <title>Silueta Campesino</title>
    <style>
        .container {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }

        .image-container {
            position: relative;
            margin-bottom: 20px;
        }

        .label {
            display: inline-block;
            padding: 6px 12px;
            background-color: #FF5733;
            color: #fff;
            border-radius: 8px;
            position: absolute;
            font-size: 20px;
        }

        button {
            color: #fff !important;
            padding: 7px 10px !important;
        }

        img {
            width: 40%;
        }
    </style>
</head>

<body>
    <div class="container-fluid mt-5 text-center position-relative">
        <h1 class="my-5">¿AQUI VA LA PREGUNTA DE TODO?</h1>
        <div class="image-container">
            <img src="imagen.jpg" alt="Imagen a etiquetar" id="image">
            <div id="labels"></div>
        </div>
        <div id="label-buttons" class="row mt-5"></div>

        <!-- Contenedor para alinear el botón a la derecha -->
        <div class="position-absolute top-0 end-0 m-3">
            <button type="button" class="btn btn-light text-secondary" data-bs-toggle="modal"
                data-bs-target="#exampleModal">
                Resultados
            </button>
        </div>
    </div>



    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Resultados</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modal-body">
                    Cargando....
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const palabras = ["Accesibilidad el medio de transporte", "Poco manejo de las TIC's", "Campesinos", "Comunidad rural", "Habitantes de la ruralidad dispersas", "Niños(as)", "Preferencia en el trato personal", "Carentes de transporte propio", "Adultos", "Alto manejo de las TIC's", "Uso de medios tradicionales de comunicación", "Amplio manejo de la tecnología", "Habitantes del casco urbano", "Preferencia por el trato virtual", "Abiertos al cambio", "Con alta confianza", "Desconfianza"];

        const colores = ["#c62828", "#ad1457", "#6a1b9a", "#4527a0", "#283593", "#1565c0", "#0277bd", "#00838f", "#00695c", "#2e7d32", "#558b2f", "#9e9d24", "#f9a825", "#ef6c00", "#d84315", "#4e342e", "#546e7a"];

        function generarBotones() {
            const labelButtonsContainer = document.getElementById('label-buttons');

            palabras.forEach((palabra, index) => {
                const col = document.createElement('div');
                col.classList.add('col-md-3', 'mb-2');

                const button = document.createElement('button');
                button.textContent = palabra;
                button.classList.add('btn', 'btn-light', 'w-100');
                button.style.backgroundColor = colores[index % colores.length];

                button.onclick = function () {
                    addLabel(palabra, button.style.backgroundColor);
                    saveLabels([{ label: palabra, color: button.style.backgroundColor, position: { left: 0, top: 0 } }]);
                    button.disabled = true;
                };

                col.appendChild(button);
                labelButtonsContainer.appendChild(col);
            });
        }

        function addLabel(label, color) {
            const labelElement = document.createElement('span');
            labelElement.className = 'label';
            labelElement.textContent = label;
            labelElement.style.backgroundColor = color;

            const image = document.getElementById('image');
            const imageRect = image.getBoundingClientRect();

            let labelX, labelY;
            do {
                labelX = Math.random() * imageRect.width;
                labelY = Math.random() * imageRect.height;
            } while (isOverlapping(labelX, labelY));

            labelElement.style.left = labelX + 'px';
            labelElement.style.top = labelY + 'px';

            image.parentNode.appendChild(labelElement);
        }

        function isOverlapping(x, y) {
            const labels = document.querySelectorAll('.label');
            for (let i = 0; i < labels.length; i++) {
                const labelRect = labels[i].getBoundingClientRect();
                if (x >= labelRect.left && x <= labelRect.right && y >= labelRect.top && y <= labelRect.bottom) {
                    return true;
                }
            }
            return false;
        }

        const serverUrl = 'http://localhost:8080';

        function getDeviceId() {
            const navigatorInfo = window.navigator;
            const screenInfo = window.screen;
            const timezoneOffset = new Date().getTimezoneOffset();

            const deviceId = {
                userAgent: navigatorInfo.userAgent,
                screenWidth: screenInfo.width,
                screenHeight: screenInfo.height,
                timezoneOffset: timezoneOffset
            };

            const encodedDeviceId = btoa(JSON.stringify(deviceId));

            return encodedDeviceId;
        }

        const deviceId = getDeviceId();

        function saveLabels(labelsData) {
            const savedLabels = JSON.parse(localStorage.getItem('savedLabels')) || [];
            savedLabels.push(...labelsData);
            localStorage.setItem('savedLabels', JSON.stringify(savedLabels));

            fetch(`${serverUrl}/saveLabels`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Device-Id': deviceId
                },
                body: JSON.stringify(labelsData)
            })
                .then(response => response.text())
                .then(data => {
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function disableButton(label) {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                if (button.textContent === label) {
                    button.disabled = true;
                }
            });
        }

        function getLabels() {
            fetch(`${serverUrl}/getLabels`, {
                method: 'GET',
                headers: {
                    'Device-Id': deviceId
                }
            })
                .then(response => response.json())
                .then(labels => {
                    labels.forEach(label => {
                        addLabel(label.label, label.color);
                    });
                    labels.forEach(label => {
                        if (isLabelSaved(label.label)) {
                            disableButton(label.label);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function isLabelSaved(label) {
            const savedLabels = JSON.parse(localStorage.getItem('savedLabels')) || [];
            return savedLabels.some(savedLabel => savedLabel.label === label);
        }

        function mostrarResultados() {
            fetch(`${serverUrl}/getLabels`, {
                method: 'GET',
                headers: {
                    'Device-Id': deviceId
                }
            })
                .then(response => response.json())
                .then(data => {
                    const tagCounts = {};
                    data.forEach(item => {
                        const label = item.label;
                        tagCounts[label] = (tagCounts[label] || 0) + 1;
                    });

                    const modalBody = document.getElementById('modal-body');
                    modalBody.innerHTML = '';
                    Object.entries(tagCounts).forEach(([tag, count]) => {
                        const tagElement = document.createElement('p');
                        tagElement.innerHTML = `${tag}: <strong>${count}</strong>`;
                        modalBody.appendChild(tagElement);
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        window.onload = function () {
            getLabels();
            generarBotones();

        };

        document.addEventListener("DOMContentLoaded", function () {
            const modal = new bootstrap.Modal(document.getElementById('exampleModal'));

            modal._element.addEventListener('shown.bs.modal', function () {
                mostrarResultados();
            });
        });
    </script>
</body>

</html>